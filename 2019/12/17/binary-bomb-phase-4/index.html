<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Phase 4 is our first real jump in difficulty. Like the last phase, it has multiple correct answer. The difficulty comes from recursion and another function w...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.Cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/assets/css/main.min.css ">
    <link rel="canonical" href="/2019/12/17/binary-bomb-phase-4/">
    <link rel="alternate" type="application/rss+xml" title="Caminek" href="/feed.xml ">
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Binary Bomb: Phase 4 | Caminek</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Binary Bomb: Phase 4" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Phase 4 is our first real jump in difficulty. Like the last phase, it has multiple correct answer. The difficulty comes from recursion and another function whose purpose isn’t clear from just its name. We’ll enlist Python to help." />
<meta property="og:description" content="Phase 4 is our first real jump in difficulty. Like the last phase, it has multiple correct answer. The difficulty comes from recursion and another function whose purpose isn’t clear from just its name. We’ll enlist Python to help." />
<link rel="canonical" href="/2019/12/17/binary-bomb-phase-4/" />
<meta property="og:url" content="/2019/12/17/binary-bomb-phase-4/" />
<meta property="og:site_name" content="Caminek" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-12-17T11:19:54-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Binary Bomb: Phase 4" />
<script type="application/ld+json">
{"@type":"BlogPosting","description":"Phase 4 is our first real jump in difficulty. Like the last phase, it has multiple correct answer. The difficulty comes from recursion and another function whose purpose isn’t clear from just its name. We’ll enlist Python to help.","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/12/17/binary-bomb-phase-4/"},"headline":"Binary Bomb: Phase 4","url":"/2019/12/17/binary-bomb-phase-4/","dateModified":"2019-12-17T11:19:54-05:00","datePublished":"2019-12-17T11:19:54-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->






</head>


  <body>

    <header id="top">
    <div class="wrapper">
        
            <img src="/assets/img/misc/avatar.png" alt="site.icon" width="32" height="32" style="vertical-align:middle"/>
        
        <a href="/" class="brand">Caminek</a>
        <small></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/series/">
                        
                            <i class="fa fa-book"></i>Series
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" index>
    <div class="left">
        <h1>Binary Bomb: Phase 4</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i> 2019-12-17
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#reverse-engineering" title="Category: reverse-engineering" rel="category">reverse-engineering</a>&nbsp;
    
        <a href="/category/#x86-64" title="Category: x86-64" rel="category">x86-64</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#reverse-engineering" title="Tag: reverse-engineering" rel="tag">reverse-engineering</a-->
        <a href="/tag/#reverse-engineering" title="Tag: reverse-engineering" rel="tag">reverse-engineering</a>&nbsp;
    
        <!--a href="/tag/#binary-bomb" title="Tag: binary-bomb" rel="tag">binary-bomb</a-->
        <a href="/tag/#binary-bomb" title="Tag: binary-bomb" rel="tag">binary-bomb</a>&nbsp;
    
        <!--a href="/tag/#gdb" title="Tag: gdb" rel="tag">gdb</a-->
        <a href="/tag/#gdb" title="Tag: gdb" rel="tag">gdb</a>&nbsp;
    
        <!--a href="/tag/#x86-64" title="Tag: x86-64" rel="tag">x86-64</a-->
        <a href="/tag/#x86-64" title="Tag: x86-64" rel="tag">x86-64</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
            <p>Phase 4 is our first real jump in difficulty. Like the last phase, it has multiple correct answers. The difficulty comes from recursion and another function whose purpose isn’t clear from just its name. We’ll enlist Python to help.</p>

<h1 id="phase-4">Phase 4</h1>

<p>Let’s start gdb and place a breakpoint on explode_bomb. Once that’s done, disassemble phase_4.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dump of assembler code for function phase_4:
   0x000000000040100c &lt;+0&gt;: 	sub    rsp,0x18
   0x0000000000401010 &lt;+4&gt;: 	lea    rcx,[rsp+0xc]
   0x0000000000401015 &lt;+9&gt;: 	lea    rdx,[rsp+0x8]
   0x000000000040101a &lt;+14&gt;:	mov    esi,0x4025cf
   0x000000000040101f &lt;+19&gt;:	mov    eax,0x0
   0x0000000000401024 &lt;+24&gt;:	call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;
   0x0000000000401029 &lt;+29&gt;:	cmp    eax,0x2
   0x000000000040102c &lt;+32&gt;:	jne    0x401035 &lt;phase_4+41&gt;
   0x000000000040102e &lt;+34&gt;:	cmp    DWORD PTR [rsp+0x8],0xe
   0x0000000000401033 &lt;+39&gt;:	jbe    0x40103a &lt;phase_4+46&gt;
   0x0000000000401035 &lt;+41&gt;:	call   0x40143a &lt;explode_bomb&gt;
   0x000000000040103a &lt;+46&gt;:	mov    edx,0xe
   0x000000000040103f &lt;+51&gt;:	mov    esi,0x0
   0x0000000000401044 &lt;+56&gt;:	mov    edi,DWORD PTR [rsp+0x8]
   0x0000000000401048 &lt;+60&gt;:	call   0x400fce &lt;func4&gt;
   0x000000000040104d &lt;+65&gt;:	test   eax,eax
   0x000000000040104f &lt;+67&gt;:	jne    0x401058 &lt;phase_4+76&gt;
   0x0000000000401051 &lt;+69&gt;:	cmp    DWORD PTR [rsp+0xc],0x0
   0x0000000000401056 &lt;+74&gt;:	je     0x40105d &lt;phase_4+81&gt;
   0x0000000000401058 &lt;+76&gt;:	call   0x40143a &lt;explode_bomb&gt; 
   0x000000000040105d &lt;+81&gt;:	add    rsp,0x18
   0x0000000000401061 &lt;+85&gt;:	ret    
End of assembler dump.
</code></pre></div></div>

<p>Similar to the last phase, we see sscanf. Let’s get the format string to see what this phase needs for input.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x/s 0x4025cf
0x4025cf:	"%d %d"
</code></pre></div></div>

<p>Like Phase 3, this phase will need two numbers. There’s also a check after returning from sscanf to ensure that there were two numbers read in, otherwise, we jump to explode_bomb.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x0000000000401029 &lt;+29&gt;:	cmp    eax,0x2
   0x000000000040102c &lt;+32&gt;:	jne    0x401035 &lt;phase_4+41&gt;
   ...
   0x0000000000401035 &lt;+41&gt;:	call   0x40143a &lt;explode_bomb&gt;
</code></pre></div></div>

<p>The next check ensures that our first input is less than or equal to 15.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x000000000040102e &lt;+34&gt;:    cmp    DWORD PTR [rsp+0x8],0xe
   0x0000000000401033 &lt;+39&gt;:    jbe    0x40103a &lt;phase_4+46&gt;
   0x0000000000401035 &lt;+41&gt;:    call   0x40143a &lt;explode_bomb&gt;
</code></pre></div></div>

<p>The JBE instruction stands for Jump if Below or Equal. This instruction is similar to the JLE instruction, except JBE performs an unsigned comparison.</p>

<p>We need to make sure our first number is between 0 and 15, inclusive.</p>

<p>After, we see a few registers being set, and then a call to the recursive function, func4:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x000000000040103a &lt;+46&gt;:    mov    edx,0xe
   0x000000000040103f &lt;+51&gt;:    mov    esi,0x0
   0x0000000000401044 &lt;+56&gt;:    mov    edi,DWORD PTR [rsp+0x8]
   0x0000000000401048 &lt;+60&gt;:    call   0x400fce &lt;func4&gt;
</code></pre></div></div>

<p>These three registers hold what would have been the function arguments in the original C code.</p>

<p>Let’s disassemble func4.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dump of assembler code for function func4:
   0x0000000000400fce &lt;+0&gt;: 	sub    rsp,0x8
   0x0000000000400fd2 &lt;+4&gt;: 	mov    eax,edx
   0x0000000000400fd4 &lt;+6&gt;: 	sub    eax,esi
   0x0000000000400fd6 &lt;+8&gt;: 	mov    ecx,eax
   0x0000000000400fd8 &lt;+10&gt;:	shr    ecx,0x1f
   0x0000000000400fdb &lt;+13&gt;:	add    eax,ecx
   0x0000000000400fdd &lt;+15&gt;:	sar    eax,1
   0x0000000000400fdf &lt;+17&gt;:	lea    ecx,[rax+rsi*1]
   0x0000000000400fe2 &lt;+20&gt;:	cmp    ecx,edi
   0x0000000000400fe4 &lt;+22&gt;:	jle    0x400ff2 &lt;func4+36&gt;
   0x0000000000400fe6 &lt;+24&gt;:	lea    edx,[rcx-0x1]
   0x0000000000400fe9 &lt;+27&gt;:	call   0x400fce &lt;func4&gt;
   0x0000000000400fee &lt;+32&gt;:	add    eax,eax
   0x0000000000400ff0  &lt;+34&gt;:	jmp    0x401007 &lt;func4+57&gt;
   0x0000000000400ff2  &lt;+36&gt;:	mov    eax,0x0
   0x0000000000400ff7  &lt;+41&gt;:	cmp    ecx,edi
   0x0000000000400ff9  &lt;+43&gt;:	jge    0x401007 &lt;func4+57&gt;
   0x0000000000400ffb  &lt;+45&gt;:	lea    esi,[rcx+0x1]
   0x0000000000400ffe  &lt;+48&gt;:	call   0x400fce &lt;func4&gt;
   0x0000000000401003 &lt;+53&gt;:	lea    eax,[rax+rax*1+0x1]
   0x0000000000401007 &lt;+57&gt;:	add    rsp,0x8
   0x000000000040100b &lt;+61&gt;:	ret    
End of assembler dump.
</code></pre></div></div>

<p>While the function is only 21 lines of assembly, it can become tricky to keep all the state correct, and a bit of a burden if you happen to start with an invalid number, and have to start again. I opted at this point to create a python program of the above assembly code to test all of the numbers automatically.</p>

<p>For the function name, I chose to keep it as func4. The argument names I kept as the register names. I figured this would be the easiest way to track where I was in the assembly code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edx</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
	<span class="k">pass</span>
</code></pre></div></div>

<p>We can ignore the first line as its only making for the address it will eventually have to push on the stack. We don’t have to manage the stack, python will do that for us.</p>

<p>Here are the next seven lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x0000000000400fd2 &lt;+4&gt;: 	mov    eax,edx
   0x0000000000400fd4 &lt;+6&gt;: 	sub    eax,esi
   0x0000000000400fd6 &lt;+8&gt;: 	mov    ecx,eax
   0x0000000000400fd8 &lt;+10&gt;:	shr    ecx,0x1f
   0x0000000000400fdb &lt;+13&gt;:	add    eax,ecx
   0x0000000000400fdd &lt;+15&gt;:	sar    eax,1
   0x0000000000400fdf &lt;+17&gt;:    lea    ecx,[rax+rsi*1]
</code></pre></div></div>

<p>These lines are doing the following:</p>

<ul>
  <li>eax = edx</li>
  <li>eax = eax - esi</li>
  <li>ecx = eax</li>
  <li>ecx = ecx » 31</li>
  <li>eax = eax + ecx</li>
  <li>eax = eax » 1</li>
  <li>ecx = eax + esi * 1</li>
</ul>

<p>We could write that into our code, but there’s a lot of simplifications we can make.</p>

<p>Look at EAX. It’s set to EDX which is never going to be greater than 15 or 0b1111. We then decrement it by ESI and set that value to EAX.</p>

<p>We then set ECX to equal EAX, and then take this 4-bit number and shift it 31 bits to the right. This means ECX will always be 0 at this point.</p>

<p>We add 0 to EAX and then shift it once to the right.</p>

<p>We then set ECX = EAX + ESI * 1. Multiplying by one serves no purpose, so we can skip that. The value of EAX hasn’t changed since the second bullet point.</p>

<p>We can simplify the 7 lines above to:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ecx</span> <span class="o">=</span> <span class="n">esi</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">-</span> <span class="n">esi</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s look at the next 4 lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x0000000000400fe2 &lt;+20&gt;:    cmp    ecx,edi
   0x0000000000400fe4 &lt;+22&gt;:    jle    0x400ff2 &lt;func4+36&gt;
   0x0000000000400fe6 &lt;+24&gt;:    lea    edx,[rcx-0x1]
   0x0000000000400fe9 &lt;+27&gt;:    call   0x400fce &lt;func4&gt;
</code></pre></div></div>

<p>Here we compare the value stored in ECX with the one in EDI. Remember, EDI is the number between 0 - 15 we’ve entered.</p>

<p>If EDI is less than or equal to ECX, we jump to another part of the function. Otherwise, we subtract 1 from the ECX and set EDX to that value. We then recursively call func4.</p>

<p>Let’s put the lines of python we have together:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edx</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
	<span class="n">ecx</span> <span class="o">=</span> <span class="n">esi</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">-</span> <span class="n">esi</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
	
	<span class="k">if</span> <span class="n">edi</span> <span class="o">&lt;=</span> <span class="n">ecx</span><span class="p">:</span>
		<span class="n">eax</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="p">,</span> <span class="n">ecx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>After the recursion reaches the end and starts unwinding, we’ll eventually reach the code after the recursive call to func4 was called. Let’s look at the code once we reach that point.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x0000000000400fee &lt;+32&gt;:    add    eax,eax
   0x0000000000400ff0  &lt;+34&gt;:    jmp    0x401007 &lt;func4+57&gt;
   ...
   0x0000000000401007 &lt;+57&gt;:    add    rsp,0x8
   0x000000000040100b &lt;+61&gt;:    ret
</code></pre></div></div>

<p>It appears that the number multiplies itself by two, sets moves the stack pointer and returns. Let’s add this to the python code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edx</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
	<span class="n">ecx</span> <span class="o">=</span> <span class="n">esi</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">-</span> <span class="n">esi</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
	
	<span class="k">if</span> <span class="n">edi</span> <span class="o">&lt;=</span> <span class="n">ecx</span><span class="p">:</span>
		<span class="n">eax</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="p">,</span> <span class="n">ecx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">eax</span>
</code></pre></div></div>

<p>Now that we have that portion of the function written, let’s explore the path that takes us further down into the function.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x0000000000400ff2  &lt;+36&gt;:    mov    eax,0x0
   0x0000000000400ff7  &lt;+41&gt;:    cmp    ecx,edi
   0x0000000000400ff9  &lt;+43&gt;:    jge    0x401007 &lt;func4+57&gt;
   0x0000000000400ffb  &lt;+45&gt;:    lea    esi,[rcx+0x1]
   0x0000000000400ffe  &lt;+48&gt;:    call   0x400fce &lt;func4&gt;
   0x0000000000401003 &lt;+53&gt;:    lea    eax,[rax+rax*1+0x1]
   0x0000000000401007 &lt;+57&gt;:    add    rsp,0x8
   0x000000000040100b &lt;+61&gt;:    ret   
</code></pre></div></div>

<p>Here we see EAX being set to 0x0, followed by a comparison of ECX and our input stored at EDI. If EDI is greater or equal to ECX, then we jump to the end of the function.</p>

<p>Otherwise, set ESI = RCX + 0x1 and call func4. Once we return from this call, we’ll set EAX = EAX + EAX * 1 + 0x1.</p>

<p>Let’s update our python code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edx</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
	<span class="n">ecx</span> <span class="o">=</span> <span class="n">esi</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">-</span> <span class="n">esi</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
	
	<span class="k">if</span> <span class="n">edi</span> <span class="o">&lt;=</span> <span class="n">ecx</span><span class="p">:</span>
		<span class="n">eax</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="p">,</span> <span class="n">ecx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">eax</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">eax</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">ecx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">edx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">eax</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p>We have all the cases accounted for except one. A way to exit the loop:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">edx</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
	<span class="n">ecx</span> <span class="o">=</span> <span class="n">esi</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">-</span> <span class="n">esi</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
	
	<span class="k">if</span> <span class="n">ecx</span> <span class="o">==</span> <span class="n">edi</span><span class="p">:</span>
        	<span class="k">return</span> <span class="mi">0</span>
	<span class="k">elif</span> <span class="n">edi</span> <span class="o">&lt;=</span> <span class="n">ecx</span><span class="p">:</span>
		<span class="n">eax</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">esi</span><span class="p">,</span> <span class="n">ecx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">eax</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">eax</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">ecx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">edx</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eax</span> <span class="o">+</span> <span class="n">eax</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p>The only thing missing is a driver program and we can generate our valid first numbers:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Valid first numbers: "</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">func4</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">" "</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="/downloads/binary_bomb/phase_4/phase_4.py">Download phase_4.py</a> or combine the code above with the complete func4 code into a text file, and save it as phase_4.py.</p>

<p>You may need to specify that this is a python 3 file depending on your the default version of python you are using. If the above doesn’t work, try python3 phase_4.py.  Any troubleshooting beyond this left to the reader.</p>

<p>The output of this code shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Valid first numbers: 0 1 3 7
</code></pre></div></div>

<p>Now, let’s return to phase_4 and find our second valid number.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x000000000040104d &lt;+65&gt;:    test   eax,eax
   0x000000000040104f &lt;+67&gt;:    jne    0x401058 &lt;phase_4+76&gt;
   ...
   0x0000000000401058 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;
</code></pre></div></div>

<p>If EAX is 0, then test eax,eax will set the zero flag which will cause the jump on the next line to not be taken.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   0x0000000000401051 &lt;+69&gt;:    cmp    DWORD PTR [rsp+0xc],0x0
   0x0000000000401056 &lt;+74&gt;:    je     0x40105d &lt;phase_4+81&gt;
   0x0000000000401058 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;
   0x000000000040105d &lt;+81&gt;:    add    rsp,0x18
   0x0000000000401061 &lt;+85&gt;:    ret    
</code></pre></div></div>

<p>The CMP checks to see if our second number is 0. If it’s not, the bomb will explode. Our second number can only be 0.</p>

<p>Restart the bomb and use any one of the four valid first numbers, and 0 as your second number.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to my fiendish little bomb. You have 6 phases with
which to blow yourself up. Have a nice day!
Phase 1 defused. How about the next one?
That's number 2.  Keep going!
Halfway there!
3 0
So you got that one.  Try this one.
</code></pre></div></div>

<p>Make sure to update your answer.txt file with the answer to this Phase!</p>


        </article>
        <hr>
        

        <div class="post-recent">
    <div class="pre" style="display:inline-block; margin-top: 20px;">
        
        <p><i class="fa fa-arrow-left"></i> <a href="/2019/12/16/binary-bomb-phase-3/">Binary Bomb: Phase 3</a></p>
        
    </div>
    <div class="nex" style="display:inline-block; margin-top: 20px; float:right;">
        
        <p><a href="/2019/12/17/binary-bomb-phase-5/">Binary Bomb: Phase 5</a> <i class="fa fa-arrow-right"></i></p>
        
    </div>
</div>

        
        
        

    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">
            
            <!-- Series -->
            <div class="side ">
                <div>
                    <i class="fa fa-book" aria-hidden="true"></i>
                    Series
                </div>
                <ul class="content-ul" srs>
                    
                    
                    

                    

                    
                    

                    
                        
                            <li>
                                
                                    <a href="/2019/12/18/binary-bomb-phase-6/">Binary Bomb: Phase 6</a>
                                
                            </li>
                        

                    
                        
                            <li>
                                
                                    <a href="/2019/12/17/binary-bomb-phase-5/">Binary Bomb: Phase 5</a>
                                
                            </li>
                        

                    
                        
                            <li>
                                
                                    <strong>Binary Bomb: Phase 4</strong>
                                
                            </li>
                        

                    
                        
                            <li>
                                
                                    <a href="/2019/12/16/binary-bomb-phase-3/">Binary Bomb: Phase 3</a>
                                
                            </li>
                        

                    
                        
                            <li>
                                
                                    <a href="/2019/12/16/binary-bomb-phase-2/">Binary Bomb: Phase 2</a>
                                
                            </li>
                        

                    
                </ul>
            </div>

            <!-- Recent -->
            <div class="side">
                <div>
                    <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                    Recent Posts
                </div>
                <ul class="content-ul" recent>
                    
                        <li><a href="/2021/06/01/natas27-28/">Natas Level 27 → Level 28</a></li>
                    
                        <li><a href="/2021/05/31/natas26-27/">Natas Level 26 → Level 27</a></li>
                    
                        <li><a href="/2021/05/31/natas25-26/">Natas Level 25 → Level 26</a></li>
                    
                        <li><a href="/2021/05/30/natas24-25/">Natas Level 24 → Level 25</a></li>
                    
                        <li><a href="/2021/05/30/natas23-24/">Natas Level 23 → Level 24</a></li>
                    
                </ul>
            </div>
            
            <!-- Content -->
            <div class="side ">
                <div>
                    <i class="fa fa-th-list"></i>
                    Categories
                </div>
                <ul class="content-ul" cate>
                    
                    <li>
                        <a href="/category/#reverse-engineering" class="categories-list-item" cate="reverse-engineering">
                            <span class="name">
                                reverse-engineering
                            </span>
                            <span class="badge">13</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#x86-64" class="categories-list-item" cate="x86-64">
                            <span class="name">
                                x86-64
                            </span>
                            <span class="badge">8</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#ctf" class="categories-list-item" cate="ctf">
                            <span class="name">
                                ctf
                            </span>
                            <span class="badge">69</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#wargames" class="categories-list-item" cate="wargames">
                            <span class="name">
                                wargames
                            </span>
                            <span class="badge">64</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#linux" class="categories-list-item" cate="linux">
                            <span class="name">
                                linux
                            </span>
                            <span class="badge">35</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/category/#web-security" class="categories-list-item" cate="web-security">
                            <span class="name">
                                web-security
                            </span>
                            <span class="badge">29</span>
                        </a>
                    </li>
                    
                </ul>
            </div>

            <!-- Tag Cloud -->
            
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<!-- <script src="/assets/js/pageContent.js " charset="utf-8"></script> -->


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="contact">
            Find me on: 
            <a href="https://github.com/caminek" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a> 
             
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>, and modified by <a href="https://github.com/caminek">caminek</a>.
            </span>
        </p>
    </div>
</footer>

    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <!-- <script src=" /assets/js/main.js " charset="utf-8"></script>
    <script src=" /assets/js/smooth-scroll.min.js " charset="utf-8"></script> -->
    <script src=" /assets/js/all.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /assets/js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
